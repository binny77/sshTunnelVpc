"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CustomActionsRunnerVwsStack = exports.CustomActionsRunnerVwsStackDeploymentPolicy = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_ec2_1 = require("aws-cdk-lib/aws-ec2");
const aws_ecr_1 = require("aws-cdk-lib/aws-ecr");
const ecs = require("aws-cdk-lib/aws-ecs");
const aws_ecs_1 = require("aws-cdk-lib/aws-ecs");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const aws_kms_1 = require("aws-cdk-lib/aws-kms");
const aws_secretsmanager_1 = require("aws-cdk-lib/aws-secretsmanager");
const cfn_proxy_1 = require("../vws/cfn-proxy");
const cfn_shared_vpc_1 = require("../vws/cfn-shared-vpc");
const clusterNamePrefix = 'GitHubActionsRunnerCluster';
const serviceNamePrefix = 'GitHubActionsRunnerService';
const executionRoleNamePrefix = 'GitHubActionsRunnerTaskExecutionRole';
const securityGroupNamePrefix = 'GitHubActionsRunnerSecurityGroup';
const taskDefinitionFamilyPrefix = 'GitHubActionsRunnerTaskDefinitionFamily';
class CustomActionsRunnerVwsStackDeploymentPolicy extends aws_iam_1.Policy {
    constructor(scope, id, props) {
        const policyProps = {
            statements: [
                new aws_iam_1.PolicyStatement({
                    effect: aws_iam_1.Effect.ALLOW,
                    actions: [
                        'ec2:CreateSecurityGroup',
                        'ec2:DescribeSecurityGroups',
                        'ecs:CreateCluster',
                        'ecs:RegisterTaskDefinition',
                        'ecs:DescribeTaskDefinition',
                        'ecs:DeregisterTaskDefinition',
                    ],
                    // no resource restrictions possible
                    resources: ['*'],
                }),
                new aws_iam_1.PolicyStatement({
                    effect: aws_iam_1.Effect.ALLOW,
                    actions: [
                        'ec2:AuthorizeSecurityGroupEgress',
                        'ec2:DeleteSecurityGroup',
                        'ec2:RevokeSecurityGroupEgress',
                    ],
                    // security group id is not known
                    resources: [`arn:aws:ec2:${aws_cdk_lib_1.Fn.ref('AWS::Region')}:${aws_cdk_lib_1.Fn.ref('AWS::AccountId')}:*`],
                }),
                new aws_iam_1.PolicyStatement({
                    effect: aws_iam_1.Effect.ALLOW,
                    actions: [
                        'ecs:DeleteCluster',
                        'ecs:DescribeClusters',
                    ],
                    resources: [
                        `arn:aws:ecs:${aws_cdk_lib_1.Fn.ref('AWS::Region')}:${aws_cdk_lib_1.Fn.ref('AWS::AccountId')}:cluster/${clusterNamePrefix}*`,
                    ],
                }),
                new aws_iam_1.PolicyStatement({
                    effect: aws_iam_1.Effect.ALLOW,
                    actions: [
                        'ecs:CreateService',
                        'ecs:DeleteService',
                        'ecs:DescribeServices',
                    ],
                    resources: [
                        `arn:aws:ecs:${aws_cdk_lib_1.Fn.ref('AWS::Region')}:${aws_cdk_lib_1.Fn.ref('AWS::AccountId')}:service/${clusterNamePrefix}*/${serviceNamePrefix}*`,
                    ],
                }),
                new aws_iam_1.PolicyStatement({
                    effect: aws_iam_1.Effect.ALLOW,
                    actions: [
                        'cloudformation:DescribeStacks',
                        'cloudformation:CreateChangeSet',
                        'cloudformation:DescribeChangeSet',
                        'cloudformation:ExecuteChangeSet',
                        'cloudformation:GetTemplateSummary',
                        'cloudformation:DeleteStack',
                        'cloudformation:CreateStack',
                        'cloudformation:UpdateStack',
                    ],
                    resources: [
                        `arn:aws:cloudformation:${aws_cdk_lib_1.Fn.ref('AWS::Region')}:${aws_cdk_lib_1.Fn.ref('AWS::AccountId')}:stack/${props.stackName}*`,
                    ],
                }),
                new aws_iam_1.PolicyStatement({
                    effect: aws_iam_1.Effect.ALLOW,
                    actions: [
                        'ssm:GetParameters',
                    ],
                    resources: [`arn:aws:ssm:${aws_cdk_lib_1.Fn.ref('AWS::Region')}:${aws_cdk_lib_1.Fn.ref('AWS::AccountId')}:parameter/cdk-bootstrap/*`],
                }),
                new aws_iam_1.PolicyStatement({
                    effect: aws_iam_1.Effect.ALLOW,
                    actions: [
                        'iam:CreateRole',
                        'iam:GetRole',
                        'iam:GetRolePolicy',
                        'iam:DeleteRole',
                        'iam:DeleteRolePolicy',
                        'iam:PutRolePolicy',
                        'iam:PassRole',
                    ],
                    resources: [`arn:aws:iam::${aws_cdk_lib_1.Fn.ref('AWS::AccountId')}:role/${executionRoleNamePrefix}*`],
                }),
                new aws_iam_1.PolicyStatement({
                    effect: aws_iam_1.Effect.ALLOW,
                    actions: [
                        'iam:PassRole',
                    ],
                    resources: [props.roleArn],
                }),
                new aws_iam_1.PolicyStatement({
                    effect: aws_iam_1.Effect.ALLOW,
                    actions: [
                        'logs:CreateLogGroup',
                        'logs:PutRetentionPolicy',
                        'logs:DescribeLogGroups',
                    ],
                    resources: [`arn:aws:logs:${aws_cdk_lib_1.Fn.ref('AWS::Region')}:${aws_cdk_lib_1.Fn.ref('AWS::AccountId')}:*`],
                }),
            ],
        };
        super(scope, id, policyProps);
    }
}
exports.CustomActionsRunnerVwsStackDeploymentPolicy = CustomActionsRunnerVwsStackDeploymentPolicy;
class CustomActionsRunnerVwsStack extends aws_cdk_lib_1.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        const runnerTag = new aws_cdk_lib_1.CfnParameter(this, 'RunnerTagParameter', {
            description: 'The tag to use in GH Actions via runs-on.',
            type: 'String',
            default: props.runnerTag ? props.runnerTag : 'vws',
        }).valueAsString;
        const runnerName = new aws_cdk_lib_1.CfnParameter(this, 'RunnerNameParameter', {
            description: 'Name of your runner. Must be unique per repo.',
            type: 'String',
            default: props.runnerName ? props.runnerName : 'vws-runner',
        }).valueAsString;
        const suffix = new aws_cdk_lib_1.CfnParameter(this, 'SuffixParameter', {
            description: 'To avoid name clashes when deploying stack multiple times into the same account. Needed for testing.',
            type: 'String',
            default: props.suffix ? props.suffix : '',
        }).valueAsString;
        const roleArn = new aws_cdk_lib_1.CfnParameter(this, 'RoleArnParameter', {
            description: 'ARN of the role that the container of the Runner will use.',
            type: 'String',
            default: props.roleArn,
            minLength: 1,
        }).valueAsString;
        const privateKeyCmkArn = new aws_cdk_lib_1.CfnParameter(this, 'PrivateKeyCmkArnParameter', {
            description: 'ARN of CMK encrypting the private key.',
            type: 'String',
            default: props.privateKeyCmkArn,
            minLength: 1,
        }).valueAsString;
        const privateKeySecret = new aws_cdk_lib_1.CfnParameter(this, 'PrivateKeySecretParameter', {
            description: 'name of the secret containing the private key of your GH App.',
            type: 'String',
            default: props.privateKeySecret,
            minLength: 1,
        }).valueAsString;
        const githubOrg = new aws_cdk_lib_1.CfnParameter(this, 'GithubOrgParameter', {
            description: 'Your GH org.',
            type: 'String',
            default: props.githubOrg,
            minLength: 1,
        }).valueAsString;
        const githubRepo = new aws_cdk_lib_1.CfnParameter(this, 'GithubRepoParameter', {
            description: 'Your GH repo.',
            type: 'String',
            default: props.githubRepo,
            minLength: 1,
        }).valueAsString;
        const githubAppId = new aws_cdk_lib_1.CfnParameter(this, 'GithubAppIdParameter', {
            description: 'The appId of your GH App that is used to authenticate the runner.',
            type: 'String',
            default: props.githubAppId,
            minLength: 1,
        }).valueAsString;
        const sharedVpc = new cfn_shared_vpc_1.CfnSharedVpc(this, 'SharedPipelineVpc');
        const vpc = sharedVpc.vpc(this.availabilityZones);
        // https://docs.github.com/en/actions/hosting-your-own-runners/about-self-hosted-runners#communication-between-self-hosted-runners-and-github
        const proxy = new cfn_proxy_1.CfnProxy(this, 'PipelineProxy', {
            allowedCidrs: [],
            allowedPorts: [443],
            allowedSuffixes: [
                'github.com',
                'pipelines.actions.githubusercontent.com',
                'actions.githubusercontent.com',
                'github-releases.githubusercontent.com',
                'github-registry-files.githubusercontent.com',
                'codeload.github.com',
                'pkg.github.com',
                'pkg-cache.githubusercontent.com',
                'pkg-containers.githubusercontent.com',
                'pkg-containers-az.githubusercontent.com',
            ],
        });
        const proxyCredentials = new cfn_proxy_1.CfnProxyCredentials(this, 'ProxyCredentials', {
            instance: proxy,
            principals: [new aws_iam_1.AccountPrincipal(aws_cdk_lib_1.Stack.of(this).account).arn],
        });
        const proxySecret = aws_secretsmanager_1.Secret.fromSecretAttributes(this, 'ImportedSecret', { secretCompleteArn: proxyCredentials.secretsArn });
        const cluster = new aws_ecs_1.Cluster(this, 'Cluster', {
            clusterName: `${clusterNamePrefix}${suffix}`,
            vpc: vpc,
        });
        const executionRole = new aws_iam_1.Role(this, 'TaskExecutionRole', {
            roleName: `${executionRoleNamePrefix}${suffix}`,
            assumedBy: new aws_iam_1.ServicePrincipal('ecs-tasks.amazonaws.com'),
        });
        executionRole.addToPolicy(new aws_iam_1.PolicyStatement({
            effect: aws_iam_1.Effect.ALLOW,
            actions: [
                'kms:Decrypt',
                'kms:DescribeKey',
            ],
            resources: [
                `arn:aws:kms:${aws_cdk_lib_1.Fn.ref('AWS::Region')}:637378239786:key/*`,
            ],
        }));
        executionRole.addToPolicy(new aws_iam_1.PolicyStatement({
            effect: aws_iam_1.Effect.ALLOW,
            actions: [
                'secretsmanager:GetSecretValue',
            ],
            resources: [
                `arn:aws:secretsmanager:${aws_cdk_lib_1.Fn.ref('AWS::Region')}:637378239786:secret:vws/resources/proxy/production/*`,
            ],
        }));
        const taskDefinition = new aws_ecs_1.FargateTaskDefinition(this, 'TaskDefinition', {
            family: `${taskDefinitionFamilyPrefix}${suffix}`,
            memoryLimitMiB: 512,
            taskRole: aws_iam_1.Role.fromRoleArn(this, 'RunnerRole', roleArn, {
                mutable: false,
            }),
            executionRole: executionRole,
        });
        const privateKeyCmk = aws_kms_1.Key.fromKeyArn(this, 'PrivateKeyCmk', privateKeyCmkArn);
        privateKeyCmk.grantDecrypt(executionRole);
        const privateKey = aws_secretsmanager_1.Secret.fromSecretNameV2(this, 'PrivateKey', privateKeySecret);
        privateKey.grantRead(executionRole);
        const repository = aws_ecr_1.Repository.fromRepositoryArn(this, 'Repository', 'arn:aws:ecr:eu-west-1:326168051205:repository/github-actions-runner');
        taskDefinition.addContainer('DefaultContainer', {
            image: aws_ecs_1.ContainerImage.fromEcrRepository(repository, props.version),
            environment: {
                PROXY_DNS_NAME: proxy.dnsName,
                NO_PROXY: 'amazonaws.com',
                NAME: runnerName,
                TAG: runnerTag,
                GITHUB_APP_ID: githubAppId,
                GITHUB_ORG: githubOrg,
                GITHUB_REPO: githubRepo,
            },
            secrets: {
                PROXY_USER: ecs.Secret.fromSecretsManager(proxySecret, 'username'),
                PROXY_PASSWORD: ecs.Secret.fromSecretsManager(proxySecret, 'password'),
                GITHUB_APP_PRIVATE_KEY: ecs.Secret.fromSecretsManager(privateKey),
            },
            logging: aws_ecs_1.LogDriver.awsLogs({
                streamPrefix: 'runner',
            }),
        });
        const securityGroup = new aws_ec2_1.SecurityGroup(this, 'SecurityGroup', {
            vpc: vpc,
            securityGroupName: `${securityGroupNamePrefix}${suffix}`,
        });
        new aws_ecs_1.FargateService(this, 'Service', {
            serviceName: `${serviceNamePrefix}${suffix}`,
            cluster: cluster,
            taskDefinition: taskDefinition,
            minHealthyPercent: 0,
            maxHealthyPercent: 100,
            securityGroups: [securityGroup],
        });
    }
}
exports.CustomActionsRunnerVwsStack = CustomActionsRunnerVwsStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3VzdG9tLWFjdGlvbnMtcnVubmVyLXZ3cy1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImN1c3RvbS1hY3Rpb25zLXJ1bm5lci12d3Mtc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNkNBQWtFO0FBQ2xFLGlEQUFvRDtBQUNwRCxpREFBaUQ7QUFDakQsMkNBQTJDO0FBQzNDLGlEQUFnSDtBQUNoSCxpREFRNkI7QUFDN0IsaURBQTBDO0FBQzFDLHVFQUF3RDtBQUV4RCxnREFBaUU7QUFDakUsMERBQXFEO0FBRXJELE1BQU0saUJBQWlCLEdBQUcsNEJBQTRCLENBQUM7QUFDdkQsTUFBTSxpQkFBaUIsR0FBRyw0QkFBNEIsQ0FBQztBQUN2RCxNQUFNLHVCQUF1QixHQUFHLHNDQUFzQyxDQUFDO0FBQ3ZFLE1BQU0sdUJBQXVCLEdBQUcsa0NBQWtDLENBQUM7QUFDbkUsTUFBTSwwQkFBMEIsR0FBRyx5Q0FBeUMsQ0FBQztBQW9CN0UsTUFBYSwyQ0FBNEMsU0FBUSxnQkFBTTtJQUNyRSxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQTRCO1FBQ3BFLE1BQU0sV0FBVyxHQUFnQjtZQUMvQixVQUFVLEVBQUU7Z0JBQ1YsSUFBSSx5QkFBZSxDQUFDO29CQUNsQixNQUFNLEVBQUUsZ0JBQU0sQ0FBQyxLQUFLO29CQUNwQixPQUFPLEVBQUU7d0JBQ1AseUJBQXlCO3dCQUN6Qiw0QkFBNEI7d0JBQzVCLG1CQUFtQjt3QkFDbkIsNEJBQTRCO3dCQUM1Qiw0QkFBNEI7d0JBQzVCLDhCQUE4QjtxQkFDL0I7b0JBQ0Qsb0NBQW9DO29CQUNwQyxTQUFTLEVBQUUsQ0FBQyxHQUFHLENBQUM7aUJBQ2pCLENBQUM7Z0JBQ0YsSUFBSSx5QkFBZSxDQUFDO29CQUNsQixNQUFNLEVBQUUsZ0JBQU0sQ0FBQyxLQUFLO29CQUNwQixPQUFPLEVBQUU7d0JBQ1Asa0NBQWtDO3dCQUNsQyx5QkFBeUI7d0JBQ3pCLCtCQUErQjtxQkFDaEM7b0JB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