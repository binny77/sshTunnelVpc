"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.OutgoingProxyCredentials = exports.OutgoingProxy = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const aws_kms_1 = require("aws-cdk-lib/aws-kms");
const aws_secretsmanager_1 = require("aws-cdk-lib/aws-secretsmanager");
const generated_1 = require("../generated");
/**
 * Creates VWS::Proxy::Instance
 *
 * @see https://docs.vwapps.cloud/vws-vanguard/services/resources/proxy/
 */
class OutgoingProxy extends aws_cdk_lib_1.Resource {
    constructor(scope, id, props) {
        super(scope, id);
        this.resource = new generated_1.CfnInstance(this, 'Resource', {
            allowedCidrs: props.allowedCidrs,
            allowedPorts: props.allowedPorts,
            allowedSuffixes: props.allowedSuffixes,
        });
    }
    get id() {
        return this.resource.attrId;
    }
    get serviceName() {
        return this.resource.attrServiceName;
    }
    get dnsName() {
        return this.resource.attrDnsName;
    }
}
exports.OutgoingProxy = OutgoingProxy;
/**
 * Creates VWS::Proxy::Credentials and grants access to them for all iam.IGrantable principals
 *
 * @see https://docs.vwapps.cloud/vws-vanguard/services/resources/proxy/
 */
class OutgoingProxyCredentials extends aws_cdk_lib_1.Resource {
    constructor(scope, id, props) {
        super(scope, id);
        this.resource = new generated_1.CfnCredentials(this, 'Resource', {
            instance: props.instance.id,
            principals: props.principals.map(x => {
                if (x instanceof aws_iam_1.AccountPrincipal) {
                    return x.arn;
                }
                else {
                    return x.roleArn;
                }
            }),
        });
        for (let principal of props.principals) {
            if (!(principal instanceof aws_iam_1.AccountPrincipal)) {
                this.grantRead(principal);
            }
        }
        this.secret = aws_secretsmanager_1.Secret.fromSecretPartialArn(this, 'Secret', this.resource.attrSecretArn);
        this.kmsKey = aws_kms_1.Key.fromKeyArn(this, 'Key', this.resource.attrKmsKeyArn);
    }
    grantRead(identity) {
        aws_iam_1.Grant.addToPrincipal({
            grantee: identity,
            actions: [
                'secretsmanager:GetResourcePolicy',
                'secretsmanager:GetSecretValue',
                'secretsmanager:DescribeSecret',
                'secretsmanager:ListSecretVersionIds',
            ],
            resourceArns: [this.resource.attrSecretArn],
        });
        aws_iam_1.Grant.addToPrincipal({
            grantee: identity,
            actions: [
                'kms:Decrypt',
                'kms:DescribeKey',
            ],
            resourceArns: [this.resource.attrKmsKeyArn],
        });
    }
}
exports.OutgoingProxyCredentials = OutgoingProxyCredentials;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3V0Z29pbmctcHJveHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJvdXRnb2luZy1wcm94eS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw2Q0FBdUM7QUFFdkMsaURBQXFFO0FBQ3JFLGlEQUFnRDtBQUNoRCx1RUFBaUU7QUFFakUsNENBQTJEO0FBUTNEOzs7O0dBSUc7QUFDSCxNQUFhLGFBQWMsU0FBUSxzQkFBUTtJQUl6QyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQXlCO1FBQ2pFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDakIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLHVCQUFXLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRTtZQUNoRCxZQUFZLEVBQUUsS0FBSyxDQUFDLFlBQVk7WUFDaEMsWUFBWSxFQUFFLEtBQUssQ0FBQyxZQUFZO1lBQ2hDLGVBQWUsRUFBRSxLQUFLLENBQUMsZUFBZTtTQUN2QyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsSUFBSSxFQUFFO1FBQ0osT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQztJQUM5QixDQUFDO0lBRUQsSUFBVyxXQUFXO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUM7SUFDdkMsQ0FBQztJQUVELElBQVcsT0FBTztRQUNoQixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDO0lBQ25DLENBQUM7Q0FDRjtBQXhCRCxzQ0F3QkM7QUFPRDs7OztHQUlHO0FBQ0gsTUFBYSx3QkFBeUIsU0FBUSxzQkFBUTtJQU1wRCxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQW9DO1FBQzVFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDakIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLDBCQUFjLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRTtZQUNuRCxRQUFRLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQzNCLFVBQVUsRUFBRSxLQUFLLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRTtnQkFDbkMsSUFBSSxDQUFDLFlBQVksMEJBQWdCLEVBQUU7b0JBQ2pDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQztpQkFDZDtxQkFBTTtvQkFDTCxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUM7aUJBQ2xCO1lBQ0gsQ0FBQyxDQUFDO1NBQ0gsQ0FBQyxDQUFDO1FBRUgsS0FBSyxJQUFJLFNBQVMsSUFBSSxLQUFLLENBQUMsVUFBVSxFQUFFO1lBQ3RDLElBQUksQ0FBQyxDQUFDLFNBQVMsWUFBWSwwQkFBZ0IsQ0FBQyxFQUFFO2dCQUM1QyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQzNCO1NBQ0Y7UUFDRCxJQUFJLENBQUMsTUFBTSxHQUFHLDJCQUFNLENBQUMsb0JBQW9CLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3ZGLElBQUksQ0FBQyxNQUFNLEdBQUcsYUFBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDekUsQ0FBQztJQUVNLFNBQVMsQ0FBQyxRQUF3QjtRQUN2QyxlQUFLLENBQUMsY0FBYyxDQUFDO1lBQ25CLE9BQU8sRUFBRSxRQUFRO1lBQ2pCLE9BQU8sRUFBRTtnQkFDUCxrQ0FBa0M7Z0JBQ2xDLCtCQUErQjtnQkFDL0IsK0JBQStCO2dCQUMvQixxQ0FBcUM7YUFDdEM7WUFDRCxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQztTQUM1QyxDQUFDLENBQUM7UUFDSCxlQUFLLENBQUMsY0FBYyxDQUFDO1lBQ25CLE9BQU8sRUFBRSxRQUFRO1lBQ2pCLE9BQU8sRUFBRTtnQkFDUCxhQUFhO2dCQUNiLGlCQUFpQjthQUNsQjtZQUNELFlBQVksRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDO1NBQzVDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRjtBQWhERCw0REFnREMifQ==