#!/usr/bin/env bash
export AWS_REGION=eu-west-1

dir="$PWD"
outdir="$dir"/lib/generated

for file in "$dir"/cfn/schemas/MODULE/*
do
  fileName=$(basename "${file}")
  typeName=${fileName%.*}
  echo "$typeName"
  org=$(echo "$typeName" | awk -F: '{print tolower($1)}')
  service=$(echo "$typeName" | awk -F: '{print tolower($3)}')
  npx cdk-import cfn -l typescript --private --outdir "$outdir"/"$org"/"$service" --schema-file "$file" "$typeName"
done

for file in "$dir"/cfn/schemas/RESOURCE/*
do
  fileName=$(basename "${file}")
  typeName=${fileName%.*}
  echo "$typeName"
  org=$(echo "$typeName" | awk -F: '{print tolower($1)}')
  service=$(echo "$typeName" | awk -F: '{print tolower($3)}')
  npx cdk-import cfn -l typescript --private --outdir "$outdir"/"$org"/"$service" --schema-file "$file" "$typeName"
done

for i in $(find ./lib/generated -name "*.ts" -type f | grep -v '\.d\.ts' | grep -v 'index.ts' | sed 's#/lib/generated##' | sed 's#.ts$##' | sort); do
  echo "export * from '${i}';"
done > ./lib/generated/index.ts
